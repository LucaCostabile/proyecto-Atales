name: CI - Auth Service

on:
  push:
    branches: [ dev, test, main, dev-v2 ]
    paths:
      - 'backend/auth-service/**'
      - '.github/workflows/auth-ci.yml'

env:
  IMAGE_NAME: luca011/auth-service-atales

jobs:
  build-and-update-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Obtener fecha para tag
        id: vars
        run: echo "TAG=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push auth-service image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/auth-service
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ env.TAG }}

      - name: Checkout repo de infraestructura
        uses: actions/checkout@v3
        with:
          repository: LucaCostabile/infrastructura-Atales
          path: infra
          token: ${{ secrets.PAT_GITHUB }}

      - name: Cambiar a la rama correspondiente
        run: |
          cd infra
          BRANCH=${{ github.ref_name }}
          git fetch origin $BRANCH
          git checkout $BRANCH || git checkout -b $BRANCH origin/$BRANCH

      - name: Actualizar imagen en el deployment de auth-service
        run: |
          cd infra
          DEPLOY_FILE="overlays/auth-service/patch-deployment.yaml"
          NEW_IMAGE="${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ env.TAG }}"

          if [ ! -f "$DEPLOY_FILE" ]; then
            echo "❌ No se encontró el archivo $DEPLOY_FILE"
            exit 1
          fi

          sed -i "s|^\(\s*image:\s*\).*|\1$NEW_IMAGE|g" "$DEPLOY_FILE"
          echo "✅ Imagen actualizada a $NEW_IMAGE en $DEPLOY_FILE"

      - name: Commit y push cambios
        run: |
          cd infra
          git config user.email "lucacostabile011@gmail.com"
          git config user.name "Luca Costabile CI"

          BRANCH=${{ github.ref_name }}
          git pull --no-rebase origin $BRANCH

          git add overlays/dev/auth-service/patch-deployment.yaml

          if ! git diff --cached --quiet; then
            git commit -m "ci(auth): actualiza imagen a ${{ github.ref_name }}-${{ env.TAG }}"
            git push origin $BRANCH
            echo "✅ Cambios pushados"
          else
            echo "ℹ️ No hay cambios que aplicar"
          fi
